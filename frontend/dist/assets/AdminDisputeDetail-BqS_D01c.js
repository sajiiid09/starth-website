import{bC as z,R,j as e,B as d,L as q,$ as G,a as A,bX as i,T as Q,bY as y,t as l}from"./index-KrjukJeb.js";import{c as W}from"./Warning.es-BeHDD-et.js";import{C as x,a as p,b as g,c as h}from"./card-tLMu1Ov7.js";import{u as f,A as $,a as J,b as K,c as X,d as Y,e as Z,f as ee,g as se}from"./useAdminMutation-jiVJ-Wgr.js";import{u as ae}from"./useAdminQuery-gkE_Vin9.js";import{a as o}from"./adminService-C8aRWX_T.js";const te={OPEN:"bg-red-100 text-red-700 border-red-200",UNDER_REVIEW:"bg-amber-100 text-amber-700 border-amber-200",RESOLVED:"bg-emerald-100 text-emerald-700 border-emerald-200",REJECTED:"bg-slate-100 text-slate-700 border-slate-200"},re={REQUESTED:"bg-amber-100 text-amber-700 border-amber-200",PENDING_ADMIN_APPROVAL:"bg-amber-100 text-amber-700 border-amber-200",HELD:"bg-orange-100 text-orange-700 border-orange-200",APPROVED:"bg-blue-100 text-blue-700 border-blue-200",PAID:"bg-emerald-100 text-emerald-700 border-emerald-200",REVERSED:"bg-red-100 text-red-700 border-red-200"},I=t=>new Date(t).toLocaleString(void 0,{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"}),L=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(t/100),ie=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsx(y,{className:"h-10 w-72"}),e.jsx(y,{className:"h-44 w-full"}),e.jsx(y,{className:"h-72 w-full"})]}),ue=()=>{const{disputeId:t}=z(),[P,b]=R.useState(!1),[D,v]=R.useState(""),{data:r,isLoading:S,error:c,refetch:m}=ae(async()=>{if(!t)throw new Error("Missing dispute ID");const s=await o.getDispute(t),[N,_,F]=await Promise.all([o.getBooking(s.bookingId),o.listPayouts({q:s.bookingId}),o.listAuditLogs({q:s.bookingId})]),V=_.filter(a=>a.bookingId===s.bookingId),M=[{id:`${s.id}_created`,timestamp:s.createdAt,label:"Dispute opened",description:s.reason},...F.filter(a=>a.resourceType==="DISPUTE"&&a.resourceId===s.id||a.resourceType==="BOOKING"&&a.resourceId===s.bookingId).map(a=>({id:a.id,timestamp:a.timestamp,label:a.action.replace(/_/g," ").toLowerCase(),description:a.actor}))].sort((a,U)=>new Date(a.timestamp).getTime()-new Date(U.timestamp).getTime());return{dispute:s,booking:N,payouts:V,timeline:M}},[t],{enabled:!!t}),w=f(s=>o.updateDisputeStatus(s,"UNDER_REVIEW")),E=f(s=>o.updateDisputeStatus(s,"RESOLVED")),k=f(({bookingId:s,reason:N})=>o.holdPayoutsForBooking(s,N)),j=w.isLoading||E.isLoading||k.isLoading,T=async()=>{if(!(!r||i))try{await w.mutate(r.dispute.id),l.success("Dispute marked under review"),await m()}catch(s){l.error(s instanceof Error?s.message:"Failed to update dispute")}},O=async()=>{if(!(!r||i))try{await E.mutate(r.dispute.id),l.success("Dispute resolved"),await m()}catch(s){l.error(s instanceof Error?s.message:"Failed to resolve dispute")}},H=async()=>{if(!(!r||i))try{await k.mutate({bookingId:r.dispute.bookingId,reason:D.trim()||"Held due to dispute review"}),l.success("Related payouts moved to held"),b(!1),v(""),await m()}catch(s){l.error(s instanceof Error?s.message:"Failed to hold payouts")}};if(S)return e.jsx(ie,{});if(c||!r)return e.jsxs("div",{className:"rounded-xl border border-red-100 bg-red-50 p-6 text-red-700",children:["Failed to load dispute details. ",c==null?void 0:c.message,e.jsx(d,{variant:"outline",className:"mt-3",onClick:()=>void m(),children:"Retry"})]});const{dispute:u,booking:n,payouts:C,timeline:B}=r;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(d,{asChild:!0,variant:"ghost",className:"-ml-3 mb-2 w-fit",children:e.jsxs(q,{to:"/admin/disputes",children:[e.jsx(G,{className:"size-4"}),"Back to disputes"]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-3xl font-semibold text-gray-900",children:u.id}),e.jsx(A,{variant:"outline",className:te[u.status],children:u.status.toLowerCase().replace(/_/g," ")})]}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:u.reason})]}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-[2fr_1fr]",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs(x,{className:"border-none shadow-soft",children:[e.jsx(p,{children:e.jsx(g,{className:"text-lg",children:"Dispute timeline"})}),e.jsx(h,{className:"space-y-3",children:B.map(s=>e.jsxs("div",{className:"rounded-xl border border-gray-200 bg-white p-3",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:s.label}),e.jsx("p",{className:"text-xs text-gray-600",children:s.description}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:I(s.timestamp)})]},s.id))})]}),e.jsxs(x,{className:"border-none shadow-soft",children:[e.jsx(p,{children:e.jsx(g,{className:"text-lg",children:"Related booking summary"})}),e.jsxs(h,{className:"space-y-2 text-sm text-gray-700",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-gray-900",children:"Booking:"})," ",n.id]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-gray-900",children:"Event:"})," ",n.eventName]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-gray-900",children:"Organizer:"})," ",n.organizerName]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-gray-900",children:"Vendor:"})," ",n.vendorName]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-semibold text-gray-900",children:"Total:"})," ",L(n.totalAmountCents)]})]})]}),e.jsxs(x,{className:"border-none shadow-soft",children:[e.jsx(p,{children:e.jsx(g,{className:"text-lg",children:"Related payouts"})}),e.jsx(h,{className:"space-y-2",children:C.length===0?e.jsx("p",{className:"text-sm text-gray-600",children:"No payouts for this booking yet."}):C.map(s=>e.jsxs("div",{className:"flex items-center justify-between rounded-xl border border-gray-200 p-3",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-gray-900",children:[s.id," · ",s.type.toLowerCase()]}),e.jsxs("p",{className:"text-xs text-gray-600",children:[L(s.amountCents)," · ",I(s.requestedAt)]})]}),e.jsx(A,{variant:"outline",className:re[s.status],children:s.status.toLowerCase().replace(/_/g," ")})]},s.id))})]})]}),e.jsxs(x,{className:"border-none shadow-soft",children:[e.jsx(p,{children:e.jsx(g,{className:"text-lg",children:"Actions"})}),e.jsxs(h,{className:"space-y-3",children:[e.jsx(d,{className:"w-full",variant:"outline",onClick:()=>void T(),disabled:j||i,children:"Mark under review"}),e.jsx(d,{className:"w-full",onClick:()=>void O(),disabled:j||i,children:"Resolve dispute"}),e.jsx(d,{className:"w-full",variant:"destructive",onClick:()=>b(!0),disabled:j||i,children:"Hold related payouts"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Holding payouts applies a risk freeze to non-paid payouts for this booking."})]})]})]}),e.jsx($,{open:P,onOpenChange:b,children:e.jsxs(J,{children:[e.jsxs(K,{children:[e.jsxs(X,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"size-4 text-red-600"}),"Hold all related payouts?"]}),e.jsx(Y,{children:"This action places reservation/final payouts for this booking into a held state."})]}),e.jsx(Q,{value:D,onChange:s=>v(s.target.value),placeholder:"Optional reason shown in audit logs",rows:4}),e.jsxs(Z,{children:[e.jsx(ee,{children:"Cancel"}),e.jsx(se,{onClick:()=>void H(),disabled:i,children:"Hold payouts"})]})]})})]})};export{ue as default};
