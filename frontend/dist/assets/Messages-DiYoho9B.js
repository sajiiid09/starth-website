import{r,U as S,a9 as C,aa as K,ab as j,j as e,y as M,c as g,I as O,B as Q,t as V}from"./index-KrjukJeb.js";import{C as W,a as U,b as D}from"./card-tLMu1Ov7.js";import{S as P}from"./scroll-area-Dw8icOnJ.js";import{A,b as R}from"./avatar-tkolttA6.js";import{s as N}from"./ChatCircle.es-DeE-r4hZ.js";import{m as X}from"./PaperPlaneTilt.es-DXYVSOD_.js";import{f as E}from"./formatDistanceToNow-DuSt4Y5P.js";import"./constructNow-VLTKr-vB.js";import"./en-US-B77o_Iq_.js";import"./differenceInCalendarMonths-DCHHw2al.js";function de(){const[F,$]=r.useState(!0),[x,k]=r.useState([]),[Y,T]=r.useState({}),[n,B]=r.useState(null),[i,I]=r.useState(null),[z,v]=r.useState([]),[h,b]=r.useState(""),[p,y]=r.useState(!1);r.useEffect(()=>{H()},[]);const H=async()=>{try{const s=await S.me();B(s);const t=(await S.list()).reduce((l,d)=>(l[d.id]=d.full_name||d.email||"User",l),{});T(t);const u=(await C.filter({user_id:s.id})).map(l=>l.conversation_id);if(u.length>0){const l=await K.filter({id:{$in:u}}),d=await C.filter({conversation_id:{$in:u}}),G=await j.filter({conversation_id:{$in:u}},"-created_date",100),J=l.map(o=>{const f=d.filter(m=>m.conversation_id===o.id),_=f.find(m=>m.user_id!==s.id),c=G.find(m=>m.conversation_id===o.id);return{...o,participants:f,otherParticipantName:_&&t[_.user_id]||"User",lastMessage:(c==null?void 0:c.text)||"No messages yet",lastMessageDate:c==null?void 0:c.created_date}}).sort((o,f)=>Number(new Date(f.lastMessageDate))-Number(new Date(o.lastMessageDate)));k(J)}}catch(s){console.error("Error loading messaging data:",s)}$(!1)},L=async s=>{const a=x.find(w=>w.id===s);I(a);const t=await j.filter({conversation_id:s},"created_date");v(t)},q=async s=>{if(s.preventDefault(),!(!i||!n||!h.trim()||p)){y(!0);try{const a=await j.create({conversation_id:i.id,sender_id:n.id,text:h.trim()});v(t=>[...t,a]),b("")}catch(a){console.error("Failed to send message:",a),V.error("Failed to send message")}y(!1)}};return F?e.jsx("div",{className:"flex items-center justify-center h-screen",children:e.jsx(M,{className:"w-8 h-8 animate-spin text-gray-500"})}):e.jsx("div",{className:"min-h-screen bg-gray-50 p-4 md:p-8",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Messages"}),e.jsx("p",{className:"text-gray-600",children:"Communicate with venues and service providers"})]}),e.jsxs(W,{className:"border-none shadow-lg h-[600px] flex",children:[e.jsxs("div",{className:"w-1/3 border-r",children:[e.jsx(U,{className:"border-b",children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(N,{className:"w-5 h-5"}),"Conversations (",x.length,")"]})}),e.jsx(P,{className:"h-full",children:e.jsxs("div",{className:"p-4 space-y-2",children:[x.map(s=>{var a,t;return e.jsxs("button",{onClick:()=>L(s.id),className:g("w-full text-left p-3 rounded-lg transition-colors flex items-start gap-3",(i==null?void 0:i.id)===s.id?"bg-blue-50 border-blue-200 border":"hover:bg-gray-50"),children:[e.jsx(A,{className:"w-10 h-10 border",children:e.jsx(R,{children:((t=(a=s.otherParticipantName)==null?void 0:a[0])==null?void 0:t.toUpperCase())||"U"})}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("p",{className:"font-semibold text-gray-900 truncate",children:s.otherParticipantName}),s.lastMessageDate&&e.jsx("p",{className:"text-xs text-gray-500 flex-shrink-0",children:E(new Date(s.lastMessageDate),{addSuffix:!0})})]}),e.jsx("p",{className:"text-sm text-gray-600 truncate",children:s.lastMessage})]})]},s.id)}),x.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(N,{className:"w-12 h-12 text-gray-300 mx-auto mb-4"}),e.jsx("p",{children:"No conversations yet"}),e.jsx("p",{className:"text-sm",children:"Start messaging venues and services to see conversations here"})]})]})})]}),e.jsx("div",{className:"flex-1 flex flex-col",children:i?e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"border-b",children:e.jsx(D,{children:i.otherParticipantName})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx(P,{className:"flex-1 p-4",children:e.jsx("div",{className:"space-y-4",children:z.map(s=>{var a,t;return e.jsxs("div",{className:g("flex gap-3",s.sender_id===n.id?"justify-end":"justify-start"),children:[s.sender_id!==n.id&&e.jsx(A,{className:"w-8 h-8",children:e.jsx(R,{className:"text-xs",children:((t=(a=i.otherParticipantName)==null?void 0:a[0])==null?void 0:t.toUpperCase())||"U"})}),e.jsxs("div",{className:g("max-w-[70%] rounded-lg px-3 py-2",s.sender_id===n.id?"bg-blue-600 text-white":"bg-gray-100 text-gray-900"),children:[e.jsx("p",{className:"text-sm",children:s.text}),e.jsx("p",{className:g("text-xs mt-1",s.sender_id===n.id?"text-blue-100":"text-gray-500"),children:E(new Date(s.created_date),{addSuffix:!0})})]})]},s.id)})})}),e.jsx("div",{className:"border-t p-4",children:e.jsxs("form",{onSubmit:q,className:"flex gap-2",children:[e.jsx(O,{value:h,onChange:s=>b(s.target.value),placeholder:"Type a message...",disabled:p,className:"flex-1"}),e.jsx(Q,{type:"submit",disabled:p||!h.trim(),children:p?e.jsx(M,{className:"w-4 h-4 animate-spin"}):e.jsx(X,{className:"w-4 h-4"})})]})})]})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx(N,{className:"w-12 h-12 text-gray-300 mx-auto mb-4"}),e.jsx("p",{children:"Select a conversation to start messaging"})]})})})]})]})})}export{de as default};
