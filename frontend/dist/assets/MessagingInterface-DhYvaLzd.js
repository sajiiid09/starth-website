import{r as s,p as B,j as e,c as C,T as G,B as F,y as I,s as L,t as S,aF as T,U as V,a9 as R,aa as H,ab as _}from"./index-KrjukJeb.js";import{S as U}from"./scroll-area-Dw8icOnJ.js";import{A as K,b as O}from"./avatar-tkolttA6.js";import{f as W}from"./formatDistanceToNow-DuSt4Y5P.js";import{m as Y}from"./PaperPlaneTilt.es-DXYVSOD_.js";const q=new Map([["bold",s.createElement(s.Fragment,null,s.createElement("path",{d:"M108,84a16,16,0,1,1,16,16A16,16,0,0,1,108,84Zm128,44A108,108,0,1,1,128,20,108.12,108.12,0,0,1,236,128Zm-24,0a84,84,0,1,0-84,84A84.09,84.09,0,0,0,212,128Zm-72,36.68V132a20,20,0,0,0-20-20,12,12,0,0,0-4,23.32V168a20,20,0,0,0,20,20,12,12,0,0,0,4-23.32Z"}))],["duotone",s.createElement(s.Fragment,null,s.createElement("path",{d:"M224,128a96,96,0,1,1-96-96A96,96,0,0,1,224,128Z",opacity:"0.2"}),s.createElement("path",{d:"M144,176a8,8,0,0,1-8,8,16,16,0,0,1-16-16V128a8,8,0,0,1,0-16,16,16,0,0,1,16,16v40A8,8,0,0,1,144,176Zm88-48A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128ZM124,96a12,12,0,1,0-12-12A12,12,0,0,0,124,96Z"}))],["fill",s.createElement(s.Fragment,null,s.createElement("path",{d:"M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm-4,48a12,12,0,1,1-12,12A12,12,0,0,1,124,72Zm12,112a16,16,0,0,1-16-16V128a8,8,0,0,1,0-16,16,16,0,0,1,16,16v40a8,8,0,0,1,0,16Z"}))],["light",s.createElement(s.Fragment,null,s.createElement("path",{d:"M142,176a6,6,0,0,1-6,6,14,14,0,0,1-14-14V128a2,2,0,0,0-2-2,6,6,0,0,1,0-12,14,14,0,0,1,14,14v40a2,2,0,0,0,2,2A6,6,0,0,1,142,176ZM124,94a10,10,0,1,0-10-10A10,10,0,0,0,124,94Zm106,34A102,102,0,1,1,128,26,102.12,102.12,0,0,1,230,128Zm-12,0a90,90,0,1,0-90,90A90.1,90.1,0,0,0,218,128Z"}))],["regular",s.createElement(s.Fragment,null,s.createElement("path",{d:"M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm16-40a8,8,0,0,1-8,8,16,16,0,0,1-16-16V128a8,8,0,0,1,0-16,16,16,0,0,1,16,16v40A8,8,0,0,1,144,176ZM112,84a12,12,0,1,1,12,12A12,12,0,0,1,112,84Z"}))],["thin",s.createElement(s.Fragment,null,s.createElement("path",{d:"M140,176a4,4,0,0,1-4,4,12,12,0,0,1-12-12V128a4,4,0,0,0-4-4,4,4,0,0,1,0-8,12,12,0,0,1,12,12v40a4,4,0,0,0,4,4A4,4,0,0,1,140,176ZM124,92a8,8,0,1,0-8-8A8,8,0,0,0,124,92Zm104,36A100,100,0,1,1,128,28,100.11,100.11,0,0,1,228,128Zm-8,0a92,92,0,1,0-92,92A92.1,92.1,0,0,0,220,128Z"}))]]),P=s.forwardRef((a,n)=>s.createElement(B,{ref:n,...a,weights:q}));P.displayName="InfoIcon";const J=P;function Q({conversations:a,selectedConversationId:n,onSelectConversation:i}){return e.jsx("div",{className:"w-1/3 border-r h-full",children:e.jsx(U,{className:"h-full",children:e.jsxs("div",{className:"p-4",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Conversations"}),e.jsxs("div",{className:"space-y-2",children:[a.map(r=>{var m,o;return e.jsxs("button",{onClick:()=>i(r.id),className:C("w-full text-left p-3 rounded-lg transition-colors flex items-start gap-3",n===r.id?"bg-blue-50":"hover:bg-gray-50"),children:[e.jsx(K,{className:"w-10 h-10 border",children:e.jsx(O,{children:((o=(m=r.otherParticipantName)==null?void 0:m[0])==null?void 0:o.toUpperCase())||"U"})}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("p",{className:"font-semibold text-gray-900 truncate",children:r.otherParticipantName}),r.lastMessageDate&&e.jsx("p",{className:"text-xs text-gray-500 flex-shrink-0",children:W(new Date(r.lastMessageDate),{addSuffix:!0})})]}),e.jsx("p",{className:"text-sm text-gray-600 truncate",children:r.lastMessage})]})]},r.id)}),a.length===0&&e.jsx("p",{className:"text-center text-gray-500 pt-10",children:"No conversations yet."})]})]})})})}function X({message:a,currentUser:n}){const i=a.sender_id===(n==null?void 0:n.id);return e.jsxs("div",{className:C("flex gap-3",i?"justify-end":"justify-start"),children:[!i&&e.jsx("div",{className:"h-7 w-7 rounded-full bg-gray-200 flex items-center justify-center mt-0.5 flex-shrink-0",children:e.jsx("div",{className:"h-4 w-4 rounded-full bg-gray-400"})}),e.jsx("div",{className:C("max-w-[85%]",i&&"flex flex-col items-end"),children:a.text&&e.jsx("div",{className:C("rounded-2xl px-4 py-2.5",i?"bg-blue-600 text-white":"bg-white border border-gray-200"),children:e.jsx("p",{className:"text-sm leading-relaxed",children:a.text})})})]})}function ee({conversation:a,messages:n,onSendMessage:i,isSending:r,currentUser:m}){const[o,d]=s.useState(""),[f,c]=s.useState(!1),N=()=>{o.trim()&&(i(o),d(""))},E=async()=>{if(!(!a||f)){c(!0),S.info("Generating AI suggestion...");try{const y=`You are a helpful and professional venue manager. A client is messaging you. Based on the following conversation history, draft a polite and helpful response. Keep it concise.
---
Conversation History:
${n.slice(-5).map(w=>`${w.sender_id===m.id?"Venue Owner":"Client"}: ${w.text}`).join(`
`)}
---
Draft a response as the Venue Owner:`,u=await T({prompt:y});if(typeof u=="string")d(u),S.success("AI suggestion generated!");else throw new Error("Invalid response from AI")}catch(t){console.error("AI reply generation failed:",t),S.error("Could not generate AI suggestion.")}c(!1)}};return a?e.jsxs("div",{className:"w-2/3 h-full flex flex-col",children:[e.jsx("div",{className:"border-b p-4",children:e.jsx("h3",{className:"text-lg font-bold",children:a.otherParticipantName})}),e.jsx(U,{className:"flex-1 p-6",children:e.jsx("div",{className:"space-y-4",children:n.map(t=>e.jsx(X,{message:t,currentUser:m},t.id))})}),e.jsx("div",{className:"border-t p-4 bg-white",children:e.jsxs("div",{className:"relative",children:[e.jsx(G,{value:o,onChange:t=>d(t.target.value),placeholder:"Type your message...",className:"pr-24",onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),N())}}),e.jsxs("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1",children:[e.jsxs(F,{variant:"ghost",size:"sm",onClick:E,disabled:f||n.length===0,className:"text-blue-600 hover:text-blue-700 hover:bg-blue-50",children:[f?e.jsx(I,{className:"w-4 h-4 animate-spin"}):e.jsx(L,{className:"w-4 h-4"}),e.jsx("span",{className:"ml-1 hidden sm:inline",children:"AI Reply"})]}),e.jsx(F,{size:"icon",onClick:N,disabled:r||!o.trim(),children:r?e.jsx(I,{className:"w-4 h-4 animate-spin"}):e.jsx(Y,{className:"w-4 h-4"})})]})]})})]}):e.jsxs("div",{className:"w-2/3 h-full flex flex-col items-center justify-center bg-gray-50 text-center",children:[e.jsx(J,{className:"w-12 h-12 text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-700",children:"Select a Conversation"}),e.jsx("p",{className:"text-gray-500",children:"Choose a conversation from the left to view messages."})]})}function le(){const[a,n]=s.useState(!0),[i,r]=s.useState([]),[m,o]=s.useState({}),[d,f]=s.useState(null),[c,N]=s.useState(null),[E,t]=s.useState([]),[y,u]=s.useState(!1);s.useEffect(()=>{(async()=>{try{const l=await V.me();f(l);const A=(await V.list()).reduce((h,p)=>(h[p.id]=p.full_name||p.email,h),{});o(A);const M=(await R.filter({user_id:l.id})).map(h=>h.conversation_id);if(M.length>0){const h=await H.filter({id:{$in:M}}),p=await R.filter({conversation_id:{$in:M}}),$=await _.filter({conversation_id:{$in:M}},"-created_date",100),z=h.map(j=>{const Z=p.filter(v=>v.conversation_id===j.id),k=Z.find(v=>v.user_id!==l.id),x=$.find(v=>v.conversation_id===j.id);return{...j,participants:Z,otherParticipantName:k&&A[k.user_id]||"Unknown User",lastMessage:(x==null?void 0:x.text)||"No messages yet",lastMessageDate:x==null?void 0:x.created_date}}).sort((j,Z)=>Number(new Date(Z.lastMessageDate))-Number(new Date(j.lastMessageDate)));r(z)}}catch(l){console.error("Error loading messaging data:",l)}n(!1)})()},[]);const w=async g=>{const l=i.find(A=>A.id===g);N(l);const b=await _.filter({conversation_id:g},"created_date");t(b)},D=async g=>{if(!(!c||!d||y)){u(!0);try{const l=await _.create({conversation_id:c.id,sender_id:d.id,text:g});t(b=>[...b,l])}catch(l){console.error("Failed to send message:",l)}u(!1)}};return a?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(I,{className:"w-8 h-8 animate-spin text-gray-400"})}):e.jsxs("div",{className:"flex h-full",children:[e.jsx(Q,{conversations:i,selectedConversationId:c==null?void 0:c.id,onSelectConversation:w}),e.jsx(ee,{conversation:c,messages:E,onSendMessage:D,isSending:y,currentUser:d})]})}export{le as M};
